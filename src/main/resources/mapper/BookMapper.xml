<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!--
  阶段二：BookMapper XML
-->
<mapper namespace="com.chaos.schoollib.mapper.BookMapper">

    <!-- 1. ResultMap: 用于 Book 实体映射 -->
    <resultMap id="BaseResultMap" type="com.chaos.schoollib.entity.Book">
        <id property="bookID" column="BookID" />
        <result property="title" column="Title" />
        <result property="author" column="Author" />
        <result property="publisher" column="Publisher" />
        <result property="isbn" column="ISBN" />
        <result property="category" column="Category" />
        <result property="stock" column="Stock" />
        <result property="total" column="Total" />
    </resultMap>

    <!-- 2. 插入 (Create) -->
    <insert id="insert" parameterType="com.chaos.schoollib.entity.Book"
            useGeneratedKeys="true" keyProperty="bookID">
        INSERT INTO Book (Title, Author, Publisher, ISBN, Category, Stock, Total)
        VALUES (#{title}, #{author}, #{publisher}, #{isbn}, #{category}, #{stock}, #{total})
    </insert>

    <!-- 3. 查询 (Read) - By ID -->
    <select id="findById" resultMap="BaseResultMap">
        SELECT * FROM Book WHERE BookID = #{bookId}
    </select>

    <!-- 4. 查询 (Read) - All -->
    <select id="findAll" resultMap="BaseResultMap">
        SELECT * FROM Book
    </select>

    <!-- 5. 更新 (Update) -->
    <update id="update" parameterType="com.chaos.schoollib.entity.Book">
        UPDATE Book
        SET
            Title = #{title},
            Author = #{author},
            Publisher = #{publisher},
            ISBN = #{isbn},
            Category = #{category},
            Stock = #{stock},
            Total = #{total}
        WHERE BookID = #{bookID}
    </update>

    <!-- 6. 删除 (Delete) -->
    <delete id="deleteById">
        DELETE FROM Book WHERE BookID = #{bookId}
    </delete>


    <!--
      ===================================
      == 阶段四：新增并发控制 SQL ==
      ===================================
    -->

    <!--
      7. 原子化减库存 (借书)
      这是实验的核心：
      1. 我们在 WHERE 子句中检查 Stock > 0
      2. 这是一个单一的、原子化的 UPDATE 语句
      3. 如果 BookID 存在且 Stock > 0, 它会执行成功并返回 1 (affected rows)
      4. 如果 BookID 不存在或 Stock = 0, 它会执行失败并返回 0 (affected rows)
    -->
    <update id="decreaseStock">
        UPDATE Book
        SET Stock = Stock - 1
        WHERE BookID = #{bookId} AND Stock > 0
    </update>

    <!--
      8. 原子化加库存 (还书)
    -->
    <update id="increaseStock">
        UPDATE Book
        SET Stock = Stock + 1
        WHERE BookID = #{bookId}
    </update>

</mapper>